########################################
# MCU
########################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h743xx_1D0044000851303230373534-if00
restart_method: command

########################################
# Adxl345
########################################
[mcu rpi]
serial: /tmp/klipper_host_mcu

[input_shaper]
#shaper_freq_x: 91.8
#shaper_type_x: ei
#shaper_freq_y: 59.4
#shaper_type_y: mzv

########################################
# MACRO
########################################
[include Macros/*.cfg]
[include OrbiterSensor.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]

########################################
# SDCARD
########################################
[virtual_sdcard]
path: /home/pi/printer_data/gcodes


#########################################
#########################################

[skew_correction]
########################################
# PRINTER
########################################
[printer]
kinematics: corexy
max_velocity: 700
max_accel: 5500
max_z_velocity: 25
max_z_accel: 30
max_accel_to_decel: 5500
SQUARE_CORNER_VELOCITY= 7
########################################
# STEPPER
########################################
[stepper_x]
step_pin: PD4 
dir_pin: PD3 
enable_pin: !PD6 
microsteps: 64
rotation_distance: 40
endstop_pin: !PC1 
position_endstop: 0
position_min: -6
position_max: 320
homing_speed: 150
homing_retract_dist: 0
second_homing_speed: 10.0

[stepper_y]
step_pin: PA15 
dir_pin: PA8 
enable_pin: !PD1 
microsteps: 64
rotation_distance: 40
endstop_pin: !PC3 
position_endstop: 0
position_max: 318
position_min: -32
homing_retract_dist: 0
homing_speed: 150
second_homing_speed: 10.0

[stepper_z]
step_pin: PE2 
dir_pin: PE3 
enable_pin: !PE0 
microsteps: 64
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
position_max: 400
position_min: -5


[extruder]
step_pin: PD15
dir_pin: PD14
enable_pin: !PC7
microsteps: 16
rotation_distance: 4.393
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB3
sensor_type: PT1000
sensor_pin: PA2
#control: pid
#pid_Kp: 18.831
#pid_Ki: 0.821
#pid_Kd: 108.044
min_extrude_temp: 185
min_temp: 0
max_temp: 300
max_extrude_only_distance: 1000
max_extrude_cross_section: 5
########################################
# TMC2209 configuration
########################################

[tmc2209 stepper_x]
uart_pin: PD5 
run_current: 1.5
hold_current = 1.5
interpolate = True
sense_resistor = 0.110
driver_sgthrs = 100
stealthchop_threshold = 0

[tmc2209 stepper_y]
uart_pin: PD0 
run_current: 1.5
hold_current: 1.5
interpolate = True
sense_resistor = 0.110
driver_sgthrs = 100
stealthchop_threshold = 0

[tmc2209 stepper_z]
uart_pin: PE1
run_current: 1
hold_current: 1
interpolate = True
sense_resistor = 0.110
driver_sgthrs = 100

#[tmc2209 stepper_z1]
#uart_pin: PD12
#run_current: 0.800
#hold_current: 0.500
#diag_pin:
#interpolate = True
#sense_resistor = 0.110
#stealthchop_threshold = 250
#driver_sgthrs = 100

[tmc2209 extruder]
uart_pin: PC6
run_current: 0.85
hold_current = 0.1
#diag_pin:
#interpolate = True
#sense_resistor = 0.110
#stealthchop_threshold = 250
#driver_sgthrs = 100
########################################
# HEATER
########################################
[heater_bed]
heater_pin: PD7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA1
#control: pid
min_temp: 0
max_temp: 130
#pid_Kp: 73.932
#pid_Ki: 1.521
#pid_Kd: 898.279
########################################
# FAN
########################################
[heater_fan hotend_fan]
pin: PB6
fan_speed: 1

[fan]
pin: rpi:gpio26
max_power: 0.8
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[fan_generic Aux_Fan] 
pin: PB7
max_power: 1
shutdown_speed: 0
off_below: 0.36
kick_start_time: 3
cycle_time: 0.00045
hardware_pwm: false


[controller_fan drivers_fan]
pin: PB5
max_power: 0.25
# Due to BTT implementing a Marlin-specific safety feature,
# "anti-reversal stepper protection", this pin needs pulling
# high to pass power to stepper drivers and most FETs

#[output_pin motor_power]
#pin: PC13
#value: 1

########################################
# FILAMENT SENSOR
########################################
[filament_switch_sensor Sensore]
pause_on_runout: True
runout_gcode:
  M600
switch_pin: !PC2 #!PA0
########################################
# IDLE TIMEOUT
########################################
[idle_timeout]
[idle_timeout]
timeout: 600
gcode:
    {% if printer.pause_resume.is_paused %}
        # Se la stampante è in pausa, spegne solo l'hotend
        M104 S0
    {% else %}
        # Se la stampante è inattiva, spegne tutti i riscaldatori e disabilita i motori
        TURN_OFF_HEATERS
        M84
        Luci_OFF
    {% endif %}




#[output_pin beeper]
#pin: PB0



########################################
# BED SCREWS
########################################
[bed_screws]
screw1: 0,0
screw2: 150,0
screw3: 305,0
screw4: 305,280
screw5: 150,280
screw6: 0,280
[screws_tilt_adjust]
screw1: 40,28
screw1_name: Uno
screw2: 190,28
screw2_name: Due
screw3: 315,28
screw3_name: Tre
screw4: 315,270
screw4_name: Quattro
screw5: 190,270
screw5_name: Cinque
screw6: 40,270
screw6_name: Sei
speed: 200.0
screw_thread: CW-M3

########################################
# TEMPERATURE
########################################
[temperature_sensor Raspberry]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

########################################
# BL-TOUCH
########################################
[idm]
serial:/dev/serial/by-id/usb-IDM_614e_1B0034001443565537353020-if00
#canbus_uuid:
# Path to the serial port for the idm device. Typically has the form
# /dev/serial/by-id/usb-idm_idm_...
speed: 40. # Z probing dive speed.
lift_speed: 5. # Z probing lift speed.
backlash_comp: 0.5
# Backlash compensation distance for removing Z backlash before measuring
# the sensor response.
x_offset: 0. # X offset of idm from the nozzle.
y_offset: 21.1 # Y offset of idm from the nozzle.
trigger_distance: 2. # idm trigger distance for homing.
trigger_dive_threshold: 1.5
# Threshold for range vs dive mode probing. Beyond `trigger_distance +
# trigger_dive_threshold` a dive will be used.
trigger_hysteresis: 0.006
# Hysteresis on trigger threshold for untriggering, as a percentage of the
# trigger threshold.
cal_nozzle_z: 0.1 # Expected nozzle offset after completing manual Z offset calibration.
cal_floor: 0.1 # Minimum z bound on sensor response measurement.
cal_ceil:5. # Maximum z bound on sensor response measurement.
cal_speed: 1.0 # Speed while measuring response curve.
cal_move_speed: 10.
# Speed while moving to position for response curve measurement.
default_model_name: default
# Name of default idm model to load.
mesh_main_direction: x
# Primary travel direction during mesh measurement.
#mesh_overscan: -1
# Distance to use for direction changes at mesh line ends. Omit this setting
# and a default will be calculated from line spacing and available travel.
mesh_cluster_size: 1 # Radius of mesh grid point clusters.
mesh_runs: 2 # Number of passes to make during mesh scan.

[lis2dw]
cs_pin: idm:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
probe_points:
  160, 160, 5

[bed_mesh]
speed: 500
probe_count: 25,25
horizontal_move_z: 10
algorithm: bicubic
mesh_min : 10,10
mesh_max : 310,295
mesh_pps: 3,3
bicubic_tension: 0.2
move_check_distance: 5.0
split_delta_z: .025
fade_start: 1.0 
fade_end: 0.0

[safe_z_home]
home_xy_position: 160,160
speed: 500
z_hop: 10
z_hop_speed: 5

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.530
#*# pid_ki = 1.441
#*# pid_kd = 73.136
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 69.668
#*# pid_ki = 1.773
#*# pid_kd = 684.491
#*#
#*# [bed_mesh Ghost]
#*# version = 1
#*# points =
#*# 	-0.325483, -0.371624, -0.395318, -0.426495, -0.437719, -0.411530, -0.446448
#*# 	-0.120965, -0.172094, -0.185812, -0.150894, -0.204518, -0.243177, -0.182071
#*# 	-0.063600, -0.002494, -0.063600, -0.048635, -0.069835, -0.053624, -0.089788
#*# 	-0.058612, 0.038659, 0.077318, 0.093530, 0.083553, 0.097271, 0.103506
#*# 	-0.109741, -0.069835, 0.018706, 0.066094, 0.013718, 0.047388, -0.003741
#*# 	-0.280589, -0.265624, -0.159624, -0.137177, -0.104753, -0.117224, -0.129694
#*# 	-0.526260, -0.458919, -0.376613, -0.366636, -0.329224, -0.294307, -0.329224
#*# tension = 0.2
#*# min_x = -7.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 3
#*# min_y = 7.0
#*# x_count = 7
#*# max_y = 256.96
#*# mesh_x_pps = 3
#*# max_x = 267.98
#*#
#*# [input_shaper]
#*# shaper_type_x = 2hump_ei
#*# shaper_freq_x = 90.4
#*# shaper_type_y = ei
#*# shaper_freq_y = 55.8
#*#
#*# [skew_correction Tronxy]
#*# xy_skew = 0.00021184245085
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [idm model default]
#*# model_coef = 1.5138930520348328,
#*# 	  1.7078324565918754,
#*# 	  0.9510803795383943,
#*# 	  -0.1502689883909809,
#*# 	  -1.3083296151565016,
#*# 	  2.9428270622467365,
#*# 	  3.0664169825273926,
#*# 	  -4.779946632751232,
#*# 	  -1.6654308628523966,
#*# 	  2.723460189132215
#*# model_domain = 3.110160323324445e-07,3.3422166889994667e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 20.532012
#*# model_offset = 0.52800
#*#
#*# [bed_mesh Vez]
#*# version = 1
#*# points =
#*# 	  0.199621, 0.194203, 0.187168, 0.184372, 0.180338, 0.195565, 0.191780, 0.190541, 0.183683, 0.177188, 0.169611, 0.157966, 0.152593, 0.147445, 0.147527, 0.135322, 0.123923, 0.107327, 0.090076
#*# 	  0.184478, 0.181780, 0.177092, 0.171145, 0.171658, 0.175513, 0.173720, 0.173549, 0.170626, 0.162848, 0.158081, 0.146493, 0.141157, 0.140929, 0.133512, 0.133728, 0.113087, 0.095181, 0.085446
#*# 	  0.177726, 0.169333, 0.163754, 0.162138, 0.162034, 0.170347, 0.166488, 0.154040, 0.152994, 0.151915, 0.151842, 0.142028, 0.135293, 0.123499, 0.123178, 0.121525, 0.111822, 0.087425, 0.071094
#*# 	  0.146046, 0.142930, 0.141299, 0.137015, 0.127861, 0.135078, 0.139247, 0.136965, 0.128898, 0.123749, 0.118314, 0.110244, 0.108837, 0.104453, 0.100173, 0.097466, 0.072076, 0.068719, 0.058258
#*# 	  0.116609, 0.110332, 0.090655, 0.098915, 0.099844, 0.101498, 0.108709, 0.101741, 0.091840, 0.095537, 0.090346, 0.091954, 0.080097, 0.068585, 0.060315, 0.059509, 0.054641, 0.038023, 0.026223
#*# 	  0.084431, 0.080497, 0.081745, 0.074795, 0.068941, 0.074037, 0.073450, 0.076691, 0.083781, 0.069591, 0.063314, 0.057399, 0.054323, 0.050514, 0.045514, 0.029827, 0.028468, 0.019986, 0.009345
#*# 	  0.080450, 0.074387, 0.066160, 0.061660, 0.056947, 0.063143, 0.071898, 0.070651, 0.068461, 0.064011, 0.062277, 0.050040, 0.045785, 0.033559, 0.031376, 0.025165, 0.024699, 0.006104, -0.007316
#*# 	  0.068691, 0.065472, 0.063376, 0.055713, 0.056817, 0.052283, 0.067692, 0.074697, 0.064170, 0.055221, 0.062677, 0.050094, 0.042168, 0.030628, 0.018131, 0.018848, 0.018006, -0.000591, -0.009194
#*# 	  0.063575, 0.058835, 0.058987, 0.050673, 0.043609, 0.047343, 0.049558, 0.056241, 0.054498, 0.046474, 0.045827, 0.042923, 0.032530, 0.017423, 0.022931, 0.017631, 0.004331, -0.011607, -0.019345
#*# 	  0.043360, 0.041722, 0.037579, 0.036613, 0.036542, 0.035554, 0.033988, 0.031821, 0.034023, 0.037992, 0.042072, 0.024981, 0.017727, 0.008952, 0.002130, 0.000528, -0.002555, -0.025687, -0.032398
#*# 	  0.034754, 0.032357, 0.020854, 0.018945, 0.019535, 0.023434, 0.026018, 0.022601, 0.020384, 0.025829, 0.020433, 0.010831, 0.006372, 0.000639, -0.003105, -0.010745, -0.019725, -0.037268, -0.047957
#*# 	  0.014564, 0.011074, 0.005569, 0.005944, 0.006595, 0.010396, 0.020127, 0.014118, 0.011505, 0.014017, 0.004680, 0.003106, -0.003560, -0.012999, -0.016134, -0.022579, -0.029363, -0.039804, -0.048187
#*# 	  0.017372, 0.016288, 0.010369, 0.010314, 0.010772, 0.017182, 0.024622, 0.023018, 0.016444, 0.017095, 0.009788, -0.002431, -0.005765, -0.013855, -0.012542, -0.013577, -0.018492, -0.036320, -0.036066
#*# 	  0.038263, 0.041751, 0.044120, 0.041437, 0.043970, 0.045262, 0.050770, 0.052209, 0.047957, 0.039808, 0.034076, 0.018970, 0.021199, 0.020627, 0.017197, 0.016085, 0.017254, 0.005774, -0.003643
#*# 	  0.064321, 0.068172, 0.067734, 0.065226, 0.066445, 0.070314, 0.073701, 0.066584, 0.063055, 0.064409, 0.058694, 0.056209, 0.050636, 0.045727, 0.045642, 0.043023, 0.043466, 0.033216, 0.028097
#*# 	  0.068612, 0.071447, 0.074472, 0.077218, 0.075932, 0.071143, 0.070056, 0.064463, 0.063700, 0.065139, 0.065258, 0.064698, 0.063255, 0.057628, 0.055982, 0.050214, 0.047609, 0.043315, 0.039358
#*# 	  0.067777, 0.070619, 0.067820, 0.065557, 0.070198, 0.068006, 0.067050, 0.060053, 0.060419, 0.063658, 0.073038, 0.074997, 0.068330, 0.061117, 0.057398, 0.058072, 0.049850, 0.041271, 0.042386
#*# 	  0.065969, 0.074043, 0.076838, 0.073953, 0.070240, 0.073036, 0.073697, 0.071236, 0.075604, 0.083643, 0.089352, 0.096834, 0.090534, 0.080274, 0.073709, 0.071515, 0.069303, 0.060135, 0.055867
#*# 	  0.077292, 0.078887, 0.080921, 0.082225, 0.078686, 0.082525, 0.085529, 0.083086, 0.084693, 0.098013, 0.106113, 0.110004, 0.104441, 0.095643, 0.091701, 0.089814, 0.088020, 0.079898, 0.074326
#*# 	  0.083605, 0.085508, 0.092489, 0.095033, 0.092583, 0.093203, 0.098850, 0.100106, 0.100526, 0.104553, 0.112226, 0.115959, 0.112957, 0.110605, 0.111342, 0.110884, 0.108153, 0.103055, 0.102122
#*# x_count = 19
#*# y_count = 20
#*# mesh_x_pps = 3
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 65.0
#*# max_x = 265.0
#*# min_y = 65.0
#*# max_y = 257.0
