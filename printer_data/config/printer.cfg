#[include adxlmcu.cfg]
[respond]
[include chopper_tune.cfg]
[include Macros/*.cfg]
[include OrbiterSensor.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]
[skew_correction]  



########################################
# MCU
########################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_0B0021000851313332323730-if00 #/dev/serial/by-id/usb-Klipper_stm32h743xx_1D0044000851303230373534-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

########################################
# SDCARD
########################################

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

########################################
# PRINTER
########################################

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 30000
max_z_velocity: 25
max_z_accel: 30
SQUARE_CORNER_VELOCITY: 5

[axis_twist_compensation]
speed: 50
horizontal_move_z: 25
calibrate_start_x: 10
calibrate_end_x: 310
calibrate_y: 163
calibrate_start_y: 30
calibrate_end_y: 300
calibrate_x: 163

[input_shaper]
#shaper_freq_x: 91.4 # center frequency for the X axis filter
#shaper_type_x: mzv # filter type for the X axis
#shaper_freq_y: 100.6 #67.2 # center frequency for the Y axis filter
#shaper_type_y: mzv # filter type for the Y axis
damping_ratio_x: 0.027 # damping ratio for the X axis
damping_ratio_y: 0.023  # damping ratio for the Y 

########################################
# STEPPER
########################################

[stepper_x]
step_pin: PA15 
dir_pin: PA8 
enable_pin: !PD1 
microsteps: 128
rotation_distance: 39.8523958079
endstop_pin: tmc5160_stepper_x:virtual_endstop  
position_endstop: -1
position_max: 325
position_min: -32
homing_retract_dist: 0
homing_speed: 100
#second_homing_speed: 10.0

[stepper_y]
step_pin: PD4 
dir_pin: PD3 
enable_pin: !PD6 
microsteps: 128
rotation_distance: 39.8523958079 #39.9113387111
endstop_pin: tmc5160_stepper_y:virtual_endstop 
position_endstop: -1
position_min: -6
position_max: 326
homing_speed: 100
homing_retract_dist: 0
#second_homing_speed: 10.0

[stepper_z]
step_pin: PE2 
dir_pin: PE3 
enable_pin: !PE0 
microsteps: 128
rotation_distance: 4.0025363438
endstop_pin: probe:z_virtual_endstop
homing_retract_dist: 0
position_max: 500
position_min: -5

[extruder]
step_pin: PD15
dir_pin: PD14
enable_pin: !PC7
microsteps: 16
rotation_distance: 4.5174
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB3
sensor_type: PT1000
sensor_pin: PA2
min_extrude_temp: 0
min_temp: 0
max_temp: 300
max_extrude_only_distance: 1000
max_extrude_cross_section: 5

########################################
# TMC configuration
########################################

#[tmc2209 stepper_x]
#uart_pin: PD5 
#run_current: 0.8
#hold_current = 0.8
#interpolate = False
#sense_resistor = 0.110
#driver_sgthrs = 100
#stealthchop_threshold = 0

[tmc5160 stepper_x]
cs_pin: PD0
spi_software_miso_pin: PE15
spi_software_mosi_pin: PE13
spi_software_sclk_pin: PE14
#diag1_pin: PC3 # use the same pin that was previously the endstop_pin! 
driver_SGT: 1 # -64 is most sensitive value, 63 is least sensitive
run_current: 1.414
stealthchop_threshold: 0
diag1_pin: ^!PC3
driver_TBL: 1
driver_TOFF: 2
driver_HSTRT: 2
driver_HEND: 2
driver_TPFD: 0
#interpolate: true

#[tmc2209 stepper_y]
#uart_pin: PD0 
#run_current: 0.8
#hold_current: 0.8
#interpolate = False
#sense_resistor = 0.110
#driver_sgthrs = 100
#stealthchop_threshold = 0

[tmc5160 stepper_y]
cs_pin: PD5
spi_software_miso_pin: PE15
spi_software_mosi_pin: PE13
spi_software_sclk_pin: PE14
#diag1_pin: ^!PC1 # use the same pin that was previously the endstop_pin! 
driver_SGT: -1 # -64 is most sensitive value, 63 is least sensitive
run_current: 1.414
stealthchop_threshold: 0
diag1_pin: ^!PC1
driver_TBL: 1
driver_TOFF: 2
driver_HSTRT: 2
driver_HEND: 2
driver_TPFD: 0

[tmc2209 stepper_z]
uart_pin: PE1
run_current: 1.061
#hold_current: 1
interpolate = False
sense_resistor = 0.110
driver_sgthrs = 100
driver_TBL: 3
driver_TOFF: 8
driver_HSTRT: 0
driver_HEND: 2
#interpolate: true

[tmc2209 extruder]
uart_pin: PC6
run_current: 0.85
#hold_current = 0.1

########################################
# HEATER
########################################

[heater_bed]
heater_pin: PD7
sensor_type: Generic 3950
sensor_pin: PA1
min_temp: 0
max_temp: 115
max_power: 0.85

########################################
# FAN
########################################

[heater_fan hotend_fan]
pin: PB6
fan_speed: 0.6

[fan]
pin: rpi:gpio26
max_power: 0.65
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[fan_generic Aux_Fan] 
pin: PB7
max_power: 0.75
shutdown_speed: 0
#off_below: 0.36
kick_start_time: 3
cycle_time: 0.00045
hardware_pwm: false

[controller_fan drivers_fan]
pin: PB5
max_power: 0.25

########################################
# FILAMENT SENSOR
########################################

#[filament_switch_sensor Sensore]
#pause_on_runout: True
#runout_gcode:
#  M600
#switch_pin: !PC2

########################################
# IDLE TIMEOUT
########################################

[idle_timeout]
timeout: 600
gcode:
    {% if printer.pause_resume.is_paused %}
        # Se la stampante è in pausa, spegne solo l'hotend
        M104 S0
    {% else %}
        # Se la stampante è inattiva, spegne tutti i riscaldatori e disabilita i motori
        TURN_OFF_HEATERS
        M84
        Luci_OFF
    {% endif %}

########################################
# BED SCREWS
########################################

[bed_screws]
screw1: 20,30.884
screw2: 160,30.884
screw3: 310,30.884
screw4: 310,280
screw5: 160,280
screw6: 20,280

[screws_tilt_adjust]
screw1: 20,10 #30.884
screw1_name: Uno
screw2: 160,10 #30.884
screw2_name: Due
screw3: 310,10 #30.884
screw3_name: Tre
screw4: 310,280
screw4_name: Quattro
screw5: 160,280
screw5_name: Cinque
screw6: 20,280
screw6_name: Sei
speed: 200.0
screw_thread: CW-M3

########################################
# TEMPERATURE
########################################

[temperature_sensor Raspberry]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

########################################
# PROBE
########################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0034001443565537353020-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 30                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.0140
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.
#calibration_method: touch

########################################
# ACCELEROMETER
########################################

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allow to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

[lis2dw]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
accel_per_hz: 150
probe_points:
  162.5, 163, 10
min_freq: 50
#max_freq: 150
sweeping_period: 0

[bed_mesh]
zero_reference_position: 163, 163
speed: 250
probe_count: 25,25
horizontal_move_z: 2
algorithm: bicubic
mesh_min : 20,30.884
mesh_max : 310,300
mesh_pps: 4,4
bicubic_tension: 1
move_check_distance: 5.0
split_delta_z: .025
#fade_start: 1.0 
#fade_end: 0.0

[safe_z_home]
home_xy_position: 162.5,163
speed: 200
z_hop: 5
z_hop_speed: 10

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.552
#*# pid_ki = 3.895
#*# pid_kd = 63.892
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.254
#*# pid_ki = 1.234
#*# pid_kd = 491.305
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.003592831501103676
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.277667, -0.240690, -0.196239, -0.152501, -0.109889, -0.075529, -0.043690, -0.022142, -0.003845, 0.020302, 0.040148, 0.055919, 0.068067, 0.075851, 0.074798, 0.067645, 0.057582, 0.043307, 0.028068, 0.013729, -0.006198, -0.031906, -0.060736, -0.090624, -0.120303
#*# 	-0.286564, -0.240774, -0.198765, -0.155184, -0.113495, -0.077546, -0.051231, -0.027778, -0.008274, 0.011129, 0.029903, 0.045013, 0.054367, 0.059020, 0.059562, 0.051872, 0.038406, 0.026891, 0.013127, -0.002987, -0.022086, -0.045636, -0.076501, -0.105160, -0.134055
#*# 	-0.304332, -0.257967, -0.215905, -0.173990, -0.132203, -0.095700, -0.068772, -0.045747, -0.022507, -0.002543, 0.014299, 0.032423, 0.044435, 0.048524, 0.050707, 0.047738, 0.038315, 0.024377, 0.015318, -0.000004, -0.020296, -0.042443, -0.068942, -0.099465, -0.125723
#*# 	-0.295997, -0.251052, -0.205477, -0.163908, -0.126033, -0.094536, -0.067689, -0.048339, -0.028562, -0.006562, 0.011885, 0.025850, 0.040800, 0.046152, 0.043179, 0.038508, 0.030853, 0.018138, 0.003967, -0.008758, -0.028884, -0.053587, -0.080773, -0.105146, -0.136467
#*# 	-0.314261, -0.271303, -0.224050, -0.179992, -0.141573, -0.114574, -0.085212, -0.061897, -0.040018, -0.019949, -0.000393, 0.015754, 0.028915, 0.035799, 0.038311, 0.032002, 0.023600, 0.013012, 0.001523, -0.012581, -0.029144, -0.049928, -0.075698, -0.102831, -0.131163
#*# 	-0.314403, -0.266748, -0.224835, -0.183649, -0.145062, -0.121776, -0.101191, -0.073043, -0.048368, -0.027802, -0.010523, 0.009239, 0.021921, 0.025805, 0.029611, 0.022959, 0.009142, 0.000275, -0.008411, -0.023329, -0.040957, -0.062417, -0.087328, -0.115255, -0.143715
#*# 	-0.327753, -0.286074, -0.243250, -0.200750, -0.162342, -0.137221, -0.112852, -0.087962, -0.062242, -0.039838, -0.022091, -0.004014, 0.012601, 0.018365, 0.018073, 0.013430, 0.003186, -0.008357, -0.015611, -0.026344, -0.043089, -0.066212, -0.088127, -0.115242, -0.143712
#*# 	-0.324032, -0.283792, -0.238743, -0.195862, -0.160829, -0.133999, -0.108428, -0.087422, -0.066205, -0.043703, -0.023720, -0.007580, 0.006240, 0.012094, 0.009799, 0.001744, -0.004239, -0.013058, -0.023495, -0.033516, -0.049339, -0.071613, -0.097427, -0.121267, -0.152455
#*# 	-0.335162, -0.288779, -0.244406, -0.205034, -0.166094, -0.137061, -0.116947, -0.095806, -0.074281, -0.055435, -0.034377, -0.016429, -0.002835, 0.005858, 0.009168, 0.002169, -0.008245, -0.015585, -0.024642, -0.037388, -0.051046, -0.069072, -0.093459, -0.120445, -0.148230
#*# 	-0.327515, -0.281433, -0.238884, -0.197107, -0.161715, -0.135124, -0.114311, -0.094106, -0.074448, -0.055107, -0.038465, -0.020060, -0.005380, 0.001345, 0.005069, 0.000850, -0.011588, -0.022226, -0.030654, -0.043929, -0.059630, -0.076840, -0.099425, -0.127313, -0.154937
#*# 	-0.333091, -0.287515, -0.242389, -0.200282, -0.167660, -0.139161, -0.115921, -0.096391, -0.078268, -0.056846, -0.040738, -0.026716, -0.010630, 0.000848, 0.003660, 0.000718, -0.006579, -0.018019, -0.030487, -0.040499, -0.054316, -0.073384, -0.092683, -0.118157, -0.147226
#*# 	-0.315796, -0.275366, -0.234980, -0.194441, -0.158424, -0.132772, -0.111560, -0.090318, -0.071714, -0.051926, -0.035780, -0.024181, -0.011886, -0.000299, 0.003782, -0.001160, -0.008556, -0.019184, -0.033351, -0.044000, -0.056165, -0.075056, -0.098013, -0.120345, -0.147204
#*# 	-0.324533, -0.276821, -0.235017, -0.194572, -0.156824, -0.131939, -0.115471, -0.094320, -0.069697, -0.052599, -0.034354, -0.017542, -0.006331, -0.000655, 0.007261, 0.006638, -0.002533, -0.013247, -0.024573, -0.037783, -0.052208, -0.066029, -0.086382, -0.112449, -0.136804
#*# 	-0.310006, -0.267914, -0.224672, -0.185788, -0.149690, -0.123720, -0.106491, -0.087230, -0.062642, -0.041633, -0.026233, -0.012364, 0.001244, 0.005581, 0.008822, 0.008739, 0.000539, -0.014453, -0.024829, -0.036382, -0.052789, -0.069754, -0.089012, -0.113350, -0.137293
#*# 	-0.306585, -0.264642, -0.224138, -0.183888, -0.147924, -0.121520, -0.100236, -0.080566, -0.059340, -0.034654, -0.014377, -0.000914, 0.010738, 0.019572, 0.020211, 0.017493, 0.013653, 0.002518, -0.011723, -0.023609, -0.038273, -0.058001, -0.078416, -0.098779, -0.123879
#*# 	-0.285873, -0.250301, -0.211771, -0.170726, -0.132705, -0.108814, -0.089490, -0.067335, -0.046455, -0.024135, -0.000834, 0.011883, 0.020376, 0.026272, 0.028089, 0.023903, 0.014963, 0.006270, -0.006346, -0.022043, -0.036791, -0.054445, -0.076175, -0.098153, -0.120671
#*# 	-0.276531, -0.236074, -0.198059, -0.163695, -0.122990, -0.091714, -0.073035, -0.054362, -0.028502, -0.003891, 0.017757, 0.035856, 0.046133, 0.047364, 0.047824, 0.045874, 0.036437, 0.026785, 0.018702, 0.005372, -0.013224, -0.030831, -0.049533, -0.075145, -0.097051
#*# 	-0.258151, -0.222827, -0.180745, -0.140768, -0.108280, -0.078816, -0.055857, -0.036220, -0.014257, 0.012961, 0.035351, 0.050003, 0.060275, 0.062242, 0.056914, 0.053251, 0.045840, 0.035307, 0.025864, 0.014844, -0.003899, -0.023483, -0.042720, -0.065315, -0.089363
#*# 	-0.246804, -0.207413, -0.166180, -0.124997, -0.090301, -0.063292, -0.040052, -0.019001, 0.003413, 0.028286, 0.053875, 0.068889, 0.077814, 0.082249, 0.079115, 0.071734, 0.065647, 0.057629, 0.045884, 0.035287, 0.019132, -0.001387, -0.023605, -0.043951, -0.067141
#*# 	-0.212631, -0.177749, -0.141559, -0.101534, -0.068141, -0.043475, -0.022579, -0.001144, 0.022977, 0.043674, 0.064441, 0.080837, 0.090206, 0.092493, 0.093872, 0.089143, 0.078894, 0.071282, 0.061154, 0.047394, 0.029552, 0.012129, -0.011605, -0.035205, -0.058593
#*# 	-0.197471, -0.159404, -0.117208, -0.077096, -0.042427, -0.018040, 0.001431, 0.021294, 0.045602, 0.064900, 0.082329, 0.099634, 0.113154, 0.117048, 0.118736, 0.115017, 0.107479, 0.096648, 0.086618, 0.073543, 0.055019, 0.036424, 0.013294, -0.012665, -0.038490
#*# 	-0.169421, -0.132156, -0.097055, -0.058814, -0.025889, -0.002405, 0.020815, 0.040930, 0.061103, 0.083166, 0.099761, 0.113947, 0.127768, 0.137654, 0.136202, 0.133237, 0.128935, 0.118483, 0.105859, 0.093241, 0.072470, 0.047072, 0.024668, -0.000188, -0.027268
#*# 	-0.162425, -0.118075, -0.079840, -0.038740, -0.000044, 0.028200, 0.037016, 0.062281, 0.085043, 0.103248, 0.121089, 0.138974, 0.150774, 0.157153, 0.160703, 0.157855, 0.153985, 0.150365, 0.133091, 0.116743, 0.095018, 0.071728, 0.046381, 0.020741, -0.003232
#*# 	-0.136769, -0.094753, -0.056176, -0.025438, 0.014180, 0.037869, 0.059973, 0.081750, 0.107151, 0.130132, 0.147378, 0.174673, 0.182223, 0.179619, 0.181688, 0.180659, 0.173215, 0.163704, 0.150123, 0.130278, 0.104859, 0.084957, 0.061011, 0.032883, 0.007998
#*# 	-0.117785, -0.076419, -0.033722, 0.004012, 0.038750, 0.067619, 0.089367, 0.109721, 0.136597, 0.168012, 0.201222, 0.226687, 0.231590, 0.221659, 0.212771, 0.206994, 0.199737, 0.187719, 0.173151, 0.155778, 0.133543, 0.113210, 0.091327, 0.065140, 0.036584
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 1.0
#*# min_x = 20.0
#*# max_x = 305.0
#*# min_y = 30.884
#*# max_y = 300.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 90.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 57.0
#*#
#*# [scanner model default]
#*# model_coef = 1.3863091368924443,
#*# 	  1.81455839517559,
#*# 	  0.7531424116886328,
#*# 	  0.3333457414950146,
#*# 	  0.3700941265302648,
#*# 	  0.4131988472292777,
#*# 	  -0.19370031832304968,
#*# 	  -0.35518679877756765,
#*# 	  0.23435313830660706,
#*# 	  0.24525034309174742
#*# model_domain = 3.2330878834420894e-07,3.3610454237283384e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 37.955476
#*# model_offset = -0.39200
#*#
#*# [scanner]
#*# scanner_touch_threshold = 3250
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.055, 0.01, 0.025
#*# compensation_start_x = 10.0
#*# compensation_end_x = 310.0
#*# zy_compensations = -0.04, -0.025, 0.03
#*# compensation_start_y = 30.0
#*# compensation_end_y = 300.0
