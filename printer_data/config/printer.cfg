##[include adxlmcu.cfg]
[respond]
[include chopper_tune.cfg]
[include Macros/*.cfg]
[include OrbiterSensor.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]
[skew_correction]  



########################################
# MCU
########################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_0B0021000851313332323730-if00 #/dev/serial/by-id/usb-Klipper_stm32h743xx_1D0044000851303230373534-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

########################################
# SDCARD
########################################

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

########################################
# PRINTER
########################################

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 30000
max_z_velocity: 25
max_z_accel: 30
SQUARE_CORNER_VELOCITY: 5

[axis_twist_compensation]
speed: 50
horizontal_move_z: 25
calibrate_start_x: 10
calibrate_end_x: 310
calibrate_y: 163
calibrate_start_y: 30
calibrate_end_y: 300
calibrate_x: 163

[input_shaper]
#shaper_freq_x: 91.4 # center frequency for the X axis filter
#shaper_type_x: mzv # filter type for the X axis
#shaper_freq_y: 100.6 #67.2 # center frequency for the Y axis filter
#shaper_type_y: mzv # filter type for the Y axis
damping_ratio_x: 0.027 # damping ratio for the X axis
damping_ratio_y: 0.023  # damping ratio for the Y 

########################################
# STEPPER
########################################

[stepper_x]
step_pin: PA15 
dir_pin: PA8 
enable_pin: !PD1 
microsteps: 128
rotation_distance: 39.8523958079
endstop_pin: tmc5160_stepper_x:virtual_endstop  
position_endstop: -1
position_max: 325
position_min: -32
homing_retract_dist: 0
homing_speed: 100
#second_homing_speed: 10.0

[stepper_y]
step_pin: PD4 
dir_pin: PD3 
enable_pin: !PD6 
microsteps: 128
rotation_distance: 39.9113387111
endstop_pin: tmc5160_stepper_y:virtual_endstop 
position_endstop: -1
position_min: -6
position_max: 326
homing_speed: 100
homing_retract_dist: 0
#second_homing_speed: 10.0

[stepper_z]
step_pin: PE2 
dir_pin: PE3 
enable_pin: !PE0 
microsteps: 128
rotation_distance: 4.0025363438
endstop_pin: probe:z_virtual_endstop
homing_retract_dist: 0
position_max: 500
position_min: -5

[extruder]
step_pin: PD15
dir_pin: PD14
enable_pin: !PC7
microsteps: 16
rotation_distance: 2.284 #4.393
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB3
sensor_type: PT1000
sensor_pin: PA2
min_extrude_temp: 0
min_temp: 0
max_temp: 300
max_extrude_only_distance: 1000
max_extrude_cross_section: 5

########################################
# TMC configuration
########################################

#[tmc2209 stepper_x]
#uart_pin: PD5 
#run_current: 0.8
#hold_current = 0.8
#interpolate = False
#sense_resistor = 0.110
#driver_sgthrs = 100
#stealthchop_threshold = 0

[tmc5160 stepper_x]
cs_pin: PD0
spi_software_miso_pin: PE15
spi_software_mosi_pin: PE13
spi_software_sclk_pin: PE14
#diag1_pin: PC3 # use the same pin that was previously the endstop_pin! 
driver_SGT: 1 # -64 is most sensitive value, 63 is least sensitive
run_current: 1.414
stealthchop_threshold: 0
diag1_pin: ^!PC3
driver_TBL: 1
driver_TOFF: 2
driver_HSTRT: 2
driver_HEND: 2
driver_TPFD: 0
#interpolate: true

#[tmc2209 stepper_y]
#uart_pin: PD0 
#run_current: 0.8
#hold_current: 0.8
#interpolate = False
#sense_resistor = 0.110
#driver_sgthrs = 100
#stealthchop_threshold = 0

[tmc5160 stepper_y]
cs_pin: PD5
spi_software_miso_pin: PE15
spi_software_mosi_pin: PE13
spi_software_sclk_pin: PE14
#diag1_pin: ^!PC1 # use the same pin that was previously the endstop_pin! 
driver_SGT: -1 # -64 is most sensitive value, 63 is least sensitive
run_current: 1.414
stealthchop_threshold: 0
diag1_pin: ^!PC1
driver_TBL: 1
driver_TOFF: 2
driver_HSTRT: 2
driver_HEND: 2
driver_TPFD: 0

[tmc2209 stepper_z]
uart_pin: PE1
run_current: 1.061
#hold_current: 1
interpolate = False
sense_resistor = 0.110
driver_sgthrs = 100
driver_TBL: 3
driver_TOFF: 8
driver_HSTRT: 0
driver_HEND: 2
#interpolate: true

[tmc2209 extruder]
uart_pin: PC6
run_current: 0.85
#hold_current = 0.1

########################################
# HEATER
########################################

[heater_bed]
heater_pin: PD7
sensor_type: Generic 3950
sensor_pin: PA1
min_temp: 0
max_temp: 115
max_power: 0.85

########################################
# FAN
########################################

[heater_fan hotend_fan]
pin: PB6
fan_speed: 0.6

[fan]
pin: rpi:gpio26
max_power: 0.65
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[fan_generic Aux_Fan] 
pin: PB7
max_power: 0.75
shutdown_speed: 0
#off_below: 0.36
kick_start_time: 3
cycle_time: 0.00045
hardware_pwm: false

[controller_fan drivers_fan]
pin: PB5
max_power: 0.25

########################################
# FILAMENT SENSOR
########################################

#[filament_switch_sensor Sensore]
#pause_on_runout: True
#runout_gcode:
#  M600
#switch_pin: !PC2

########################################
# IDLE TIMEOUT
########################################

[idle_timeout]
timeout: 600
gcode:
    {% if printer.pause_resume.is_paused %}
        # Se la stampante è in pausa, spegne solo l'hotend
        M104 S0
    {% else %}
        # Se la stampante è inattiva, spegne tutti i riscaldatori e disabilita i motori
        TURN_OFF_HEATERS
        M84
        Luci_OFF
    {% endif %}

########################################
# BED SCREWS
########################################

[bed_screws]
screw1: 20,30.884
screw2: 160,30.884
screw3: 310,30.884
screw4: 310,280
screw5: 160,280
screw6: 20,280

[screws_tilt_adjust]
screw1: 20,10 #30.884
screw1_name: Uno
screw2: 160,10 #30.884
screw2_name: Due
screw3: 310,10 #30.884
screw3_name: Tre
screw4: 310,280
screw4_name: Quattro
screw5: 160,280
screw5_name: Cinque
screw6: 20,280
screw6_name: Sei
speed: 200.0
screw_thread: CW-M3

########################################
# TEMPERATURE
########################################

[temperature_sensor Raspberry]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

########################################
# PROBE
########################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0034001443565537353020-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 30                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.5
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 2
#    Number of passes to make during mesh scan.


########################################
# ACCELEROMETER
########################################

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allow to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

[lis2dw]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
accel_per_hz: 150
probe_points:
  162.5, 163, 10
min_freq: 50
#max_freq: 150
sweeping_period: 0

[bed_mesh]
zero_reference_position: 163, 163
speed: 500
probe_count: 25,25
horizontal_move_z: 2
algorithm: bicubic
mesh_min : 20,30.884
mesh_max : 310,300
mesh_pps: 4,4
bicubic_tension: 1
move_check_distance: 5.0
split_delta_z: .025
#fade_start: 1.0 
#fade_end: 0.0

[safe_z_home]
home_xy_position: 162.5,163
speed: 200
z_hop: 5
z_hop_speed: 10

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.552
#*# pid_ki = 3.895
#*# pid_kd = 63.892
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.254
#*# pid_ki = 1.234
#*# pid_kd = 491.305
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.003592831501103676
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.196026, -0.174364, -0.140216, -0.104010, -0.068358, -0.034425, -0.007785, 0.015317, 0.033485, 0.056893, 0.077949, 0.094844, 0.103418, 0.108713, 0.110592, 0.105308, 0.099850, 0.091407, 0.080847, 0.069470, 0.058324, 0.038490, 0.018332, -0.003799, -0.016187
#*# 	  -0.204122, -0.174929, -0.142358, -0.106487, -0.070778, -0.042065, -0.022294, -0.000754, 0.023082, 0.041502, 0.059962, 0.082619, 0.092481, 0.096541, 0.095553, 0.093950, 0.088392, 0.079082, 0.067784, 0.055516, 0.040988, 0.029169, 0.001683, -0.015223, -0.034409
#*# 	  -0.222759, -0.185067, -0.151520, -0.118265, -0.085033, -0.055453, -0.036558, -0.018830, 0.004208, 0.027732, 0.049201, 0.073121, 0.087671, 0.082585, 0.091210, 0.089938, 0.083945, 0.069065, 0.068455, 0.063748, 0.050390, 0.034745, 0.015115, -0.002624, -0.016318
#*# 	  -0.218079, -0.187791, -0.146823, -0.114926, -0.086885, -0.059026, -0.035778, -0.018433, -0.000296, 0.028070, 0.047389, 0.059197, 0.068264, 0.076294, 0.075346, 0.069720, 0.064813, 0.059200, 0.050207, 0.048204, 0.037861, 0.022508, 0.000076, -0.016932, -0.038074
#*# 	  -0.241797, -0.206883, -0.169438, -0.132908, -0.102473, -0.077031, -0.055174, -0.035553, -0.021709, -0.000312, 0.028278, 0.043923, 0.052288, 0.056741, 0.062055, 0.058362, 0.056437, 0.054882, 0.047360, 0.043999, 0.032940, 0.018420, -0.000326, -0.015131, -0.029621
#*# 	  -0.247209, -0.212451, -0.178576, -0.142806, -0.111657, -0.083865, -0.068108, -0.047595, -0.032362, -0.013081, 0.005922, 0.022864, 0.032026, 0.037042, 0.043760, 0.040705, 0.035293, 0.036811, 0.028763, 0.016078, 0.002653, -0.007932, -0.029204, -0.041940, -0.051075
#*# 	  -0.273245, -0.244373, -0.207926, -0.174117, -0.139043, -0.106899, -0.088016, -0.073502, -0.055215, -0.032777, -0.017083, -0.002188, 0.010873, 0.020646, 0.025082, 0.025663, 0.025346, 0.025110, 0.022452, 0.018979, -0.000597, -0.018287, -0.031135, -0.043314, -0.049530
#*# 	  -0.278375, -0.245167, -0.206924, -0.169107, -0.138368, -0.110834, -0.091914, -0.076686, -0.059001, -0.038447, -0.021795, -0.011570, 0.001315, 0.011472, 0.014264, 0.009732, 0.011765, 0.011676, 0.004005, -0.006595, -0.016280, -0.030138, -0.045874, -0.053524, -0.060380
#*# 	  -0.289190, -0.257747, -0.224652, -0.187094, -0.152701, -0.116989, -0.101674, -0.084630, -0.067959, -0.050640, -0.031873, -0.016142, -0.006723, 0.004069, 0.011697, 0.010882, 0.008904, 0.007317, -0.000431, -0.010505, -0.017497, -0.028457, -0.042700, -0.053454, -0.055583
#*# 	  -0.284293, -0.253551, -0.220246, -0.183129, -0.148449, -0.120337, -0.102414, -0.089574, -0.069757, -0.054928, -0.038640, -0.024407, -0.011419, -0.001039, 0.008643, 0.007103, 0.002040, -0.007575, -0.013738, -0.022566, -0.031229, -0.038009, -0.052391, -0.063614, -0.067569
#*# 	  -0.296555, -0.264266, -0.232954, -0.198144, -0.168542, -0.136434, -0.112805, -0.095557, -0.083487, -0.063243, -0.048794, -0.038460, -0.019755, -0.002863, 0.007103, 0.010651, 0.010481, -0.000636, -0.010237, -0.019197, -0.027660, -0.038083, -0.048265, -0.059074, -0.067811
#*# 	  -0.288135, -0.259262, -0.225748, -0.189237, -0.159652, -0.138713, -0.119379, -0.099074, -0.083815, -0.065807, -0.049088, -0.034299, -0.015213, 0.003551, 0.010899, 0.005559, 0.006231, -0.004645, -0.021442, -0.029059, -0.034050, -0.042920, -0.056038, -0.066376, -0.075080
#*# 	  -0.298621, -0.264600, -0.230913, -0.196400, -0.165642, -0.137734, -0.122550, -0.102741, -0.082147, -0.063410, -0.045801, -0.028315, -0.010788, 0.003802, 0.012266, 0.010682, 0.006254, 0.004065, -0.007040, -0.016875, -0.023447, -0.029926, -0.039604, -0.053757, -0.061646
#*# 	  -0.278123, -0.253627, -0.220908, -0.182461, -0.154909, -0.131028, -0.113410, -0.093223, -0.070252, -0.051813, -0.037485, -0.021423, -0.005518, 0.005608, 0.008608, 0.005728, 0.001081, -0.008693, -0.016380, -0.022875, -0.029609, -0.037095, -0.047587, -0.059913, -0.067361
#*# 	  -0.285466, -0.256886, -0.222250, -0.186686, -0.154696, -0.129791, -0.109697, -0.090995, -0.069347, -0.040572, -0.020112, -0.008421, 0.005983, 0.016720, 0.020884, 0.017885, 0.015301, 0.008739, -0.001378, -0.006332, -0.012044, -0.024722, -0.033764, -0.044402, -0.055996
#*# 	  -0.270823, -0.241984, -0.210175, -0.173616, -0.142889, -0.122702, -0.104583, -0.082459, -0.063284, -0.041324, -0.019736, -0.003453, 0.008867, 0.014394, 0.018947, 0.016327, 0.009751, 0.005618, -0.001973, -0.008320, -0.014443, -0.025170, -0.039529, -0.050031, -0.054327
#*# 	  -0.278328, -0.249285, -0.211688, -0.176998, -0.147068, -0.123603, -0.104549, -0.085252, -0.060936, -0.035960, -0.012180, 0.008245, 0.023945, 0.028852, 0.030690, 0.029861, 0.024018, 0.018166, 0.011916, 0.007763, -0.000811, -0.008555, -0.020401, -0.033991, -0.039998
#*# 	  -0.271965, -0.236773, -0.205842, -0.169928, -0.140590, -0.116544, -0.097339, -0.075621, -0.050937, -0.026761, -0.005301, 0.012792, 0.029496, 0.035721, 0.033161, 0.029135, 0.024788, 0.019188, 0.013562, 0.010385, 0.001994, -0.010669, -0.023201, -0.034543, -0.042075
#*# 	  -0.266834, -0.238989, -0.203620, -0.167414, -0.136533, -0.108406, -0.086030, -0.063887, -0.042810, -0.021321, 0.004967, 0.025207, 0.038170, 0.049234, 0.053265, 0.046852, 0.042838, 0.039517, 0.033537, 0.027516, 0.021373, 0.010276, -0.003271, -0.014104, -0.022859
#*# 	  -0.250064, -0.214568, -0.181040, -0.144783, -0.113240, -0.088841, -0.072754, -0.052543, -0.024280, -0.003550, 0.020524, 0.039323, 0.052072, 0.058006, 0.063424, 0.058733, 0.050304, 0.045940, 0.042000, 0.035272, 0.026906, 0.014717, 0.002772, -0.012196, -0.015856
#*# 	  -0.243114, -0.207739, -0.171536, -0.135127, -0.106631, -0.076040, -0.056393, -0.035479, -0.011310, 0.011469, 0.034237, 0.051553, 0.067845, 0.076109, 0.082258, 0.082422, 0.078781, 0.073397, 0.067101, 0.062140, 0.053499, 0.037981, 0.025683, 0.010415, 0.002427
#*# 	  -0.216610, -0.179395, -0.140927, -0.108120, -0.079025, -0.053104, -0.031123, -0.010148, 0.012319, 0.035353, 0.054586, 0.068743, 0.086586, 0.095917, 0.097562, 0.095771, 0.093844, 0.087769, 0.081411, 0.075625, 0.065185, 0.049379, 0.035878, 0.021831, 0.017935
#*# 	  -0.211665, -0.175909, -0.137429, -0.099298, -0.063242, -0.036006, -0.016817, 0.007516, 0.030862, 0.051619, 0.070572, 0.089662, 0.104171, 0.114208, 0.119983, 0.118125, 0.115336, 0.113231, 0.108157, 0.101035, 0.090269, 0.075597, 0.060266, 0.047426, 0.039144
#*# 	  -0.180057, -0.141291, -0.101795, -0.063218, -0.030647, -0.004343, 0.013840, 0.037214, 0.063965, 0.081892, 0.102867, 0.122013, 0.135049, 0.140756, 0.145412, 0.144107, 0.138832, 0.134768, 0.132435, 0.120825, 0.105956, 0.091207, 0.076286, 0.061179, 0.057263
#*# 	  -0.155682, -0.123092, -0.082629, -0.038405, -0.006650, 0.022675, 0.045972, 0.065168, 0.090389, 0.115226, 0.140321, 0.160655, 0.174958, 0.184981, 0.185808, 0.179938, 0.176444, 0.171630, 0.166277, 0.159942, 0.147180, 0.129621, 0.113605, 0.098851, 0.091745
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 1.0
#*# min_x = 20.0
#*# max_x = 305.0
#*# min_y = 30.884
#*# max_y = 300.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 90.4
#*# shaper_type_y = ei
#*# shaper_freq_y = 86.2
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.08, 0.01, 0.07
#*# compensation_start_x = 10.0
#*# compensation_end_x = 310.0
#*# zy_compensations = -0.02, -0.015, 0.06
#*# compensation_start_y = 30.0
#*# compensation_end_y = 300.0
#*#
