#[include adxlmcu.cfg]
[respond]
[include chopper_tune.cfg]
[include Macros/*.cfg]
[include OrbiterSensor.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]
[skew_correction]  



########################################
# MCU
########################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_0B0021000851313332323730-if00 #/dev/serial/by-id/usb-Klipper_stm32h743xx_1D0044000851303230373534-if00
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

########################################
# SDCARD
########################################

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

########################################
# PRINTER
########################################

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 30000
max_z_velocity: 25
max_z_accel: 30
SQUARE_CORNER_VELOCITY: 5

[axis_twist_compensation]
speed: 50
horizontal_move_z: 25
calibrate_start_x: 10
calibrate_end_x: 310
calibrate_y: 163
calibrate_start_y: 30
calibrate_end_y: 300
calibrate_x: 163

[input_shaper]
#shaper_freq_x: 91.4 # center frequency for the X axis filter
#shaper_type_x: mzv # filter type for the X axis
#shaper_freq_y: 100.6 #67.2 # center frequency for the Y axis filter
#shaper_type_y: mzv # filter type for the Y axis
damping_ratio_x: 0.027 # damping ratio for the X axis
damping_ratio_y: 0.023  # damping ratio for the Y 

########################################
# STEPPER
########################################

[stepper_x]
step_pin: PA15 
dir_pin: PA8 
enable_pin: !PD1 
microsteps: 128
rotation_distance: 39.8523958079
endstop_pin: tmc5160_stepper_x:virtual_endstop  
position_endstop: -1
position_max: 325
position_min: -32
homing_retract_dist: 0
homing_speed: 100
#second_homing_speed: 10.0

[stepper_y]
step_pin: PD4 
dir_pin: PD3 
enable_pin: !PD6 
microsteps: 128
rotation_distance: 39.9113387111
endstop_pin: tmc5160_stepper_y:virtual_endstop 
position_endstop: -1
position_min: -6
position_max: 326
homing_speed: 100
homing_retract_dist: 0
#second_homing_speed: 10.0

[stepper_z]
step_pin: PE2 
dir_pin: PE3 
enable_pin: !PE0 
microsteps: 128
rotation_distance: 4.0025363438
endstop_pin: probe:z_virtual_endstop
homing_retract_dist: 0
position_max: 500
position_min: -5

[extruder]
step_pin: PD15
dir_pin: PD14
enable_pin: !PC7
microsteps: 16
rotation_distance: 2.284 #4.393
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB3
sensor_type: PT1000
sensor_pin: PA2
min_extrude_temp: 0
min_temp: 0
max_temp: 300
max_extrude_only_distance: 1000
max_extrude_cross_section: 5

########################################
# TMC configuration
########################################

#[tmc2209 stepper_x]
#uart_pin: PD5 
#run_current: 0.8
#hold_current = 0.8
#interpolate = False
#sense_resistor = 0.110
#driver_sgthrs = 100
#stealthchop_threshold = 0

[tmc5160 stepper_x]
cs_pin: PD0
spi_software_miso_pin: PE15
spi_software_mosi_pin: PE13
spi_software_sclk_pin: PE14
#diag1_pin: PC3 # use the same pin that was previously the endstop_pin! 
driver_SGT: 1 # -64 is most sensitive value, 63 is least sensitive
run_current: 1.414
stealthchop_threshold: 0
diag1_pin: ^!PC3
driver_TBL: 1
driver_TOFF: 2
driver_HSTRT: 2
driver_HEND: 2
driver_TPFD: 0
#interpolate: true

#[tmc2209 stepper_y]
#uart_pin: PD0 
#run_current: 0.8
#hold_current: 0.8
#interpolate = False
#sense_resistor = 0.110
#driver_sgthrs = 100
#stealthchop_threshold = 0

[tmc5160 stepper_y]
cs_pin: PD5
spi_software_miso_pin: PE15
spi_software_mosi_pin: PE13
spi_software_sclk_pin: PE14
#diag1_pin: ^!PC1 # use the same pin that was previously the endstop_pin! 
driver_SGT: -1 # -64 is most sensitive value, 63 is least sensitive
run_current: 1.414
stealthchop_threshold: 0
diag1_pin: ^!PC1
driver_TBL: 1
driver_TOFF: 2
driver_HSTRT: 2
driver_HEND: 2
driver_TPFD: 0

[tmc2209 stepper_z]
uart_pin: PE1
run_current: 1.061
#hold_current: 1
interpolate = False
sense_resistor = 0.110
driver_sgthrs = 100
driver_TBL: 3
driver_TOFF: 8
driver_HSTRT: 0
driver_HEND: 2
#interpolate: true

[tmc2209 extruder]
uart_pin: PC6
run_current: 0.85
#hold_current = 0.1

########################################
# HEATER
########################################

[heater_bed]
heater_pin: PD7
sensor_type: Generic 3950
sensor_pin: PA1
min_temp: 0
max_temp: 115
max_power: 0.85

########################################
# FAN
########################################

[heater_fan hotend_fan]
pin: PB6
fan_speed: 0.6

[fan]
pin: rpi:gpio26
max_power: 0.65
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[fan_generic Aux_Fan] 
pin: PB7
max_power: 0.75
shutdown_speed: 0
#off_below: 0.36
kick_start_time: 3
cycle_time: 0.00045
hardware_pwm: false

[controller_fan drivers_fan]
pin: PB5
max_power: 0.25

########################################
# FILAMENT SENSOR
########################################

#[filament_switch_sensor Sensore]
#pause_on_runout: True
#runout_gcode:
#  M600
#switch_pin: !PC2

########################################
# IDLE TIMEOUT
########################################

[idle_timeout]
timeout: 600
gcode:
    {% if printer.pause_resume.is_paused %}
        # Se la stampante è in pausa, spegne solo l'hotend
        M104 S0
    {% else %}
        # Se la stampante è inattiva, spegne tutti i riscaldatori e disabilita i motori
        TURN_OFF_HEATERS
        M84
        Luci_OFF
    {% endif %}

########################################
# BED SCREWS
########################################

[bed_screws]
screw1: 20,30.884
screw2: 160,30.884
screw3: 310,30.884
screw4: 310,280
screw5: 160,280
screw6: 20,280

[screws_tilt_adjust]
screw1: 20,10 #30.884
screw1_name: Uno
screw2: 160,10 #30.884
screw2_name: Due
screw3: 310,10 #30.884
screw3_name: Tre
screw4: 310,280
screw4_name: Quattro
screw5: 160,280
screw5_name: Cinque
screw6: 20,280
screw6_name: Sei
speed: 200.0
screw_thread: CW-M3

########################################
# TEMPERATURE
########################################

[temperature_sensor Raspberry]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

########################################
# PROBE
########################################

[mcu scanner]
#canbus_uuid: 0ca8d67388c2 
serial: /dev/serial/by-id/usb-Cartographer_614e_1B0034001443565537353020-if00
#    adjust to suit your scanner, if using usb change to serial

[scanner]
mcu: scanner            
#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 30                         
#    adjust for your cartographers offset from nozzle to middle of coil
backlash_comp: 0.0140
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
mesh_runs: 1
#    Number of passes to make during mesh scan.
#calibration_method: touch

########################################
# ACCELEROMETER
########################################

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allow to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.

[lis2dw]
cs_pin: scanner:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
accel_per_hz: 150
probe_points:
  162.5, 163, 10
min_freq: 50
#max_freq: 150
sweeping_period: 0

[bed_mesh]
zero_reference_position: 163, 163
speed: 500
probe_count: 25,25
horizontal_move_z: 2
algorithm: bicubic
mesh_min : 20,30.884
mesh_max : 310,300
mesh_pps: 4,4
bicubic_tension: 1
move_check_distance: 5.0
split_delta_z: .025
#fade_start: 1.0 
#fade_end: 0.0

[safe_z_home]
home_xy_position: 162.5,163
speed: 200
z_hop: 5
z_hop_speed: 10

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.552
#*# pid_ki = 3.895
#*# pid_kd = 63.892
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 49.254
#*# pid_ki = 1.234
#*# pid_kd = 491.305
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.003592831501103676
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.143990, -0.121718, -0.086780, -0.055283, -0.019678, 0.012773, 0.039535, 0.062148, 0.082124, 0.105965, 0.124403, 0.143256, 0.150911, 0.157600, 0.160042, 0.156619, 0.151619, 0.143604, 0.134776, 0.126485, 0.115395, 0.097505, 0.079162, 0.059080, 0.048066
#*# 	-0.157674, -0.128838, -0.097679, -0.061835, -0.027410, -0.000694, 0.019885, 0.041669, 0.066035, 0.082588, 0.103454, 0.124301, 0.133225, 0.138365, 0.139640, 0.138884, 0.134311, 0.125722, 0.116422, 0.104965, 0.092907, 0.084064, 0.059205, 0.041830, 0.024409
#*# 	-0.181707, -0.146525, -0.111689, -0.080477, -0.045312, -0.015896, 0.000191, 0.017288, 0.040357, 0.063704, 0.084574, 0.108845, 0.126859, 0.121047, 0.129701, 0.130323, 0.125320, 0.111887, 0.111448, 0.109714, 0.097027, 0.082075, 0.065921, 0.050472, 0.037719
#*# 	-0.181820, -0.154599, -0.114452, -0.079738, -0.053206, -0.026129, -0.003586, 0.013324, 0.032132, 0.057712, 0.077672, 0.090775, 0.101158, 0.109155, 0.110247, 0.105880, 0.101692, 0.098610, 0.091022, 0.090515, 0.080735, 0.067061, 0.047889, 0.031908, 0.014318
#*# 	-0.209926, -0.174406, -0.140404, -0.104008, -0.073796, -0.049571, -0.027378, -0.008966, 0.007974, 0.029487, 0.056250, 0.070855, 0.080342, 0.085909, 0.090890, 0.090843, 0.088908, 0.088991, 0.083297, 0.081257, 0.072463, 0.059435, 0.043947, 0.027869, 0.016190
#*# 	-0.219098, -0.184484, -0.152799, -0.117562, -0.086323, -0.060239, -0.045044, -0.025828, -0.007787, 0.009554, 0.028966, 0.046083, 0.055457, 0.061606, 0.069071, 0.068554, 0.063186, 0.066484, 0.059510, 0.049336, 0.036228, 0.028584, 0.010099, -0.000800, -0.007329
#*# 	-0.250475, -0.223625, -0.186680, -0.149260, -0.115452, -0.087233, -0.068717, -0.054555, -0.034713, -0.014521, 0.002415, 0.019031, 0.033242, 0.041770, 0.046615, 0.049681, 0.049928, 0.051192, 0.051473, 0.048008, 0.029616, 0.016118, 0.005769, -0.005348, -0.010926
#*# 	-0.258355, -0.225801, -0.192312, -0.155031, -0.121019, -0.094645, -0.075142, -0.060296, -0.043848, -0.022701, -0.007015, 0.003472, 0.018832, 0.028776, 0.032364, 0.029547, 0.034266, 0.033798, 0.029213, 0.020687, 0.011736, -0.000650, -0.011983, -0.018340, -0.021309
#*# 	-0.272926, -0.244241, -0.211626, -0.174464, -0.140799, -0.104361, -0.090249, -0.071304, -0.055018, -0.039236, -0.019144, -0.003339, 0.006489, 0.017762, 0.025946, 0.027291, 0.026310, 0.026430, 0.021450, 0.012894, 0.006862, -0.001872, -0.013707, -0.022789, -0.022332
#*# 	-0.276888, -0.242528, -0.210133, -0.174086, -0.139042, -0.111268, -0.095377, -0.082063, -0.061926, -0.045833, -0.029480, -0.015499, -0.001991, 0.009782, 0.019616, 0.020421, 0.017203, 0.009979, 0.003227, -0.003538, -0.009367, -0.015223, -0.025814, -0.033755, -0.036512
#*# 	-0.291163, -0.258754, -0.225050, -0.190780, -0.164077, -0.132837, -0.108962, -0.091904, -0.078780, -0.059538, -0.042799, -0.032662, -0.014744, 0.003684, 0.014057, 0.020632, 0.020442, 0.011927, 0.003074, -0.003810, -0.009052, -0.018285, -0.025733, -0.034101, -0.039863
#*# 	-0.284754, -0.255300, -0.222304, -0.189423, -0.160835, -0.138022, -0.118309, -0.098315, -0.082989, -0.064145, -0.046880, -0.033416, -0.014651, 0.007939, 0.014829, 0.012579, 0.014717, 0.005918, -0.008934, -0.015876, -0.017582, -0.025155, -0.036248, -0.044154, -0.048368
#*# 	-0.299709, -0.265736, -0.234503, -0.200607, -0.169704, -0.142658, -0.124821, -0.105936, -0.085631, -0.067148, -0.050118, -0.031312, -0.013746, 0.001537, 0.012003, 0.011104, 0.010688, 0.008345, -0.000509, -0.007756, -0.011513, -0.016461, -0.025540, -0.037504, -0.041229
#*# 	-0.281939, -0.257820, -0.223398, -0.187300, -0.159026, -0.135389, -0.118412, -0.099866, -0.077763, -0.057140, -0.042201, -0.025494, -0.009354, 0.004148, 0.008176, 0.007465, 0.004703, -0.004101, -0.010365, -0.015155, -0.018737, -0.024950, -0.031970, -0.040769, -0.047745
#*# 	-0.294130, -0.263057, -0.230229, -0.193194, -0.164783, -0.139410, -0.117545, -0.099905, -0.078331, -0.050830, -0.028368, -0.015673, -0.001930, 0.008721, 0.015569, 0.015162, 0.013861, 0.009869, 0.001154, -0.001947, -0.004824, -0.015630, -0.023286, -0.030603, -0.038160
#*# 	-0.280565, -0.251363, -0.220093, -0.183888, -0.155179, -0.134576, -0.115766, -0.094009, -0.073560, -0.051525, -0.029413, -0.013444, -0.000939, 0.007109, 0.011874, 0.010593, 0.008151, 0.004774, 0.000355, -0.004885, -0.007399, -0.016267, -0.028915, -0.036011, -0.039156
#*# 	-0.291935, -0.263079, -0.225720, -0.193080, -0.161726, -0.135662, -0.118404, -0.100280, -0.076556, -0.050273, -0.026864, -0.006256, 0.010001, 0.017285, 0.021226, 0.022153, 0.019025, 0.013955, 0.010578, 0.006758, 0.001619, -0.005010, -0.015911, -0.024313, -0.029949
#*# 	-0.286815, -0.255514, -0.220463, -0.184677, -0.157475, -0.132304, -0.113273, -0.091392, -0.068419, -0.042724, -0.018980, -0.000392, 0.016842, 0.023250, 0.022635, 0.019114, 0.017899, 0.015312, 0.009681, 0.009369, 0.003599, -0.007517, -0.016917, -0.024229, -0.030639
#*# 	-0.285604, -0.254269, -0.220549, -0.186127, -0.155352, -0.128345, -0.106515, -0.083940, -0.062003, -0.037355, -0.012589, 0.006245, 0.020664, 0.033678, 0.038486, 0.033517, 0.031900, 0.031685, 0.026267, 0.023348, 0.019476, 0.010756, -0.000510, -0.009191, -0.014764
#*# 	-0.270608, -0.234765, -0.202251, -0.166361, -0.136633, -0.112641, -0.094507, -0.072386, -0.045763, -0.024543, -0.000567, 0.020125, 0.033708, 0.041428, 0.047582, 0.043986, 0.039267, 0.036976, 0.034727, 0.030026, 0.023827, 0.015862, 0.004061, -0.007162, -0.008545
#*# 	-0.266463, -0.230668, -0.195621, -0.159827, -0.128135, -0.099540, -0.079392, -0.059787, -0.035622, -0.010381, 0.011151, 0.030139, 0.048068, 0.057798, 0.065180, 0.065800, 0.063102, 0.060923, 0.057423, 0.054897, 0.046021, 0.034853, 0.026139, 0.012828, 0.006916
#*# 	-0.241998, -0.207668, -0.171499, -0.134834, -0.107741, -0.079853, -0.057249, -0.036807, -0.014263, 0.008335, 0.028365, 0.044869, 0.063743, 0.073907, 0.076924, 0.078117, 0.077651, 0.074503, 0.069561, 0.066609, 0.058116, 0.044771, 0.034262, 0.021538, 0.021841
#*# 	-0.239954, -0.202015, -0.168410, -0.130113, -0.094660, -0.065859, -0.047420, -0.022809, 0.003130, 0.022591, 0.042312, 0.061577, 0.076383, 0.088980, 0.097664, 0.096204, 0.094865, 0.095053, 0.093414, 0.087335, 0.079406, 0.067574, 0.054536, 0.045293, 0.039002
#*# 	-0.211269, -0.172763, -0.133335, -0.095092, -0.062808, -0.039800, -0.019990, 0.004824, 0.032581, 0.051101, 0.072472, 0.092421, 0.105600, 0.113956, 0.120559, 0.121438, 0.116639, 0.116379, 0.114392, 0.104878, 0.094232, 0.082204, 0.070285, 0.056288, 0.056675
#*# 	-0.190401, -0.159111, -0.119211, -0.073099, -0.039993, -0.010012, 0.010388, 0.030897, 0.055655, 0.081362, 0.105592, 0.126862, 0.144441, 0.155016, 0.157258, 0.154530, 0.151562, 0.149570, 0.145604, 0.142044, 0.131163, 0.116941, 0.104368, 0.092950, 0.086992
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 1.0
#*# min_x = 20.0
#*# max_x = 305.0
#*# min_y = 30.884
#*# max_y = 300.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 90.4
#*# shaper_type_y = ei
#*# shaper_freq_y = 86.2
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.05, 0.01, 0.05
#*# compensation_start_x = 10.0
#*# compensation_end_x = 310.0
#*# zy_compensations = -0.0, -0.0, 0.04
#*# compensation_start_y = 30.0
#*# compensation_end_y = 300.0
#*#
#*# [scanner model default]
#*# model_coef = 1.3863091368924443,
#*# 	  1.81455839517559,
#*# 	  0.7531424116886328,
#*# 	  0.3333457414950146,
#*# 	  0.3700941265302648,
#*# 	  0.4131988472292777,
#*# 	  -0.19370031832304968,
#*# 	  -0.35518679877756765,
#*# 	  0.23435313830660706,
#*# 	  0.24525034309174742
#*# model_domain = 3.2330878834420894e-07,3.3610454237283384e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 37.955476
#*# model_offset = 0.00000
#*#
#*# [scanner]
#*# scanner_touch_threshold = 3250
